version: '3.2'

services:
  vault:
    container_name: vallheru_vault
    image: vault:1.1.0
    privileged: true
    volumes:
      - ./vault/config.hcl:/vault/config/config.hcl
      - ./wait-for.sh:/wait-for-it.sh
    command:
      - "/wait-for-it.sh"
      - "mysql:3306"
      - "--timeout=15"
      - "--"
      - "vault"
      - "server"
      - "-config=/vault/config/config.hcl"
    networks:
      apps_network:
        aliases:
          - vault
        ipv4_address: 172.16.222.11


  mysql:
    container_name: vallheru_mysql
    image: mysql:8
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/conf.d/custom.conf:/etc/mysql/conf.d/z-custom.conf
    env_file:
      - ./assets/secrets.env
    networks:
      apps_network:
        aliases:
          - mysql
        ipv4_address: 172.16.222.10


  adminer:
    image: adminer
    restart: always
    environment:
      ADMINER_DEFAULT_SERVER: mysql
    ports:
      - "8180:8080"
    networks:
      apps_network:
        aliases:
          - adminer
        ipv4_address: 172.16.222.9


  nextcloud:
    image: nextcloud
    restart: always
    environment:
      UTF8MB4_ENABLED: 0
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: root
      MYSQL_HOST: mysql
      NEXTCLOUD_TABLE_PREFIX: nc_
    ports:
      - "8181:80"
    env_file:
      - ./assets/secrets.env
    volumes:
      - ./nextcloud/nextcloud:/var/www/html
      - ./nextcloud/apps:/var/www/html/custom_apps
      - ./nextcloud/config:/var/www/html/config
      - ./nextcloud/data:/var/www/html/data
    depends_on:
      - mysql
    networks:
      apps_network:
        aliases:
          - nextcloud
        ipv4_address: 172.16.222.12


networks:
  apps_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.16.222.0/24
